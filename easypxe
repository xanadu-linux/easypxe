#!/usr/bin/env bash
# Made by Sinfallas <sinfallas@yahoo.com>
# Licence: GPL-2
LC_ALL=C
if [[ "$EUID" != "0" ]]; then
	echo -e "\e[00;31mERROR: DEBES SER ROOT\e[00m"
	exit 1
fi
trap "rm -f /run/$(basename $0).pid; exit" 0 1 2 3 15
echo "$BASHPID" > /run/$(basename $0).pid
quien=$(who | cut -d' ' -f1 | sort | uniq)

function iptables_clean () {
	if [[ -f /root/.listo ]]; then
		echo -e "\e[00;31mERROR: easypxe ya se ha ejecutado en este pc.\e[00m"
		exit 1
	fi
	iptables-save >> /home/"$quien"/iptables.save
	iptables -F
	iptables -X
	iptables -Z
	iptables -t nat -F
	iptables -t nat -X
	iptables -t mangle -F
	iptables -t mangle -X
	iptables -P INPUT ACCEPT
	iptables -P FORWARD ACCEPT
	iptables -P OUTPUT ACCEPT
}

function directorios () {
	mkdir -p /var/lib/tftpboot/pxelinux.cfg
	mkdir -p /opt/nfs

	mkdir -p /var/lib/tftpboot/Ubuntu/16.04/i386
	mkdir -p /var/lib/tftpboot/Ubuntu/16.04/amd64
	mkdir -p /opt/nfs/Ubuntu/16.04/i386
	mkdir -p /opt/nfs/Ubuntu/16.04/amd64

	mkdir -p /var/lib/tftpboot/Debian/jessie/i386
	mkdir -p /var/lib/tftpboot/Debian/jessie/amd64
	mkdir -p /opt/nfs/Debian/jessie/i386
	mkdir -p /opt/nfs/Debian/jessie/amd64

	mkdir -p /var/lib/tftpboot/fedora/12/i386
	mkdir -p /var/lib/tftpboot/fedora/12/amd64
	mkdir -p /opt/nfs/fedora/12/i386
	mkdir -p /opt/nfs/fedora/12/amd64

	mkdir -p /var/lib/tftpboot/openSUSE/11.2/i386
	mkdir -p /var/lib/tftpboot/openSUSE/11.2/amd64
	mkdir -p /opt/nfs/openSUSE/11.2/i386
	mkdir -p /opt/nfs/openSUSE/11.2/amd64

	mkdir -p /var/lib/tftpboot/CentOS/5.4/i386
	mkdir -p /var/lib/tftpboot/CentOS/5.4/amd64
	mkdir -p /opt/nfs/CentOS/5.4/i386
	mkdir -p /opt/nfs/CentOS/5.4/amd64
}

function primeros () {
	apt-get -q update
	apt-get -y install dnsmasq nfs-kernel-server tftpd-hpa syslinux
	echo "dhcp-range=192.168.1.200,192.168.1.250,12h" >> /etc/dnsmasq.conf
	echo "dhcp-no-override" >> /etc/dnsmasq.conf
	echo "enable-tftp" >> /etc/dnsmasq.conf
	echo "tftp-root=/var/lib/tftpboot" >> /etc/dnsmasq.conf
	echo "/opt/nfs	*(rw,no_root_squash,async,no_subtree_check)" >> /etc/exports
	exportfs -a
	cp /usr/lib/syslinux/pxelinux.0 /var/lib/tftpboot
	touch /var/lib/tftpboot/pxelinux.cfg/default
}

function limpieza () {
	history -c
	apt-get clean
	rm -rf /root/.local/share/Trash/*
	rm -rf /home/*/.local/share/Trash/*
	rm -rf /home/*/.cache/*
	rm -rf /tmp/*
	rm -rf /var/tmp/*
	echo -e "\e[00;1;92mFinalizado...\e[00m"
	touch /root/.listo
}

#ubuntu
echo "dhcp-boot=pxelinux.0,root,192.168.1.1" >> /etc/dnsmasq.conf
systemctl restart dnsmasq.service
wget -O - http://archive.ubuntu.com/ubuntu/dists/trusty-updates/main/installer-i386/current/images/netboot/netboot.tar.gz > /var/lib/tftpboot/netboot.tar.gz
cd /var/lib/tftpboot/
tar -xzf netboot.tar.gz
rm -f /var/lib/tftpboot/netboot.tar.gz

#debian
echo "dhcp-boot=pxelinux.0" >> /etc/dnsmasq.conf
systemctl restart dnsmasq.service
wget -O - http://httpredir.debian.org/debian/dists/jessie/main/installer-i386/current/images/netboot/netboot.tar.gz > /var/lib/tftpboot/netboot.tar.gz
cd /var/lib/tftpboot/
tar -xzf netboot.tar.gz
rm -f /var/lib/tftpboot/netboot.tar.gz

rm -f /run/$(basename $0).pid
exit 0
