#!/usr/bin/env bash
# Made by Sinfallas <sinfallas@yahoo.com>
# Licence: GPL-2
LC_ALL=C
if [[ "$EUID" != "0" ]]; then
	echo -e "\e[00;31mERROR: DEBES SER ROOT\e[00m"
	exit 1
fi
trap "rm -f /run/$(basename $0).pid; exit" 0 1 2 3 15
echo "$BASHPID" > /run/$(basename $0).pid
quien=$(who | cut -d' ' -f1 | sort | uniq)

function iptables_clean () {
	if [[ -f /root/.listo ]]; then
		echo -e "\e[00;31mERROR: easypxe ya se ha ejecutado en este pc.\e[00m"
		exit 1
	fi
	iptables-save >> /home/"$quien"/iptables.save
	iptables -F
	iptables -X
	iptables -Z
	iptables -t nat -F
	iptables -t nat -X
	iptables -t mangle -F
	iptables -t mangle -X
	iptables -P INPUT ACCEPT
	iptables -P FORWARD ACCEPT
	iptables -P OUTPUT ACCEPT
}

function directorios () {
	mkdir -p /var/lib/tftpboot/pxelinux.cfg
	mkdir -p /opt/nfs

	mkdir -p /var/lib/tftpboot/Ubuntu/16.04/i386
	mkdir -p /var/lib/tftpboot/Ubuntu/16.04/amd64
	mkdir -p /opt/nfs/Ubuntu/16.04/i386
	mkdir -p /opt/nfs/Ubuntu/16.04/amd64

	mkdir -p /var/lib/tftpboot/Debian/jessie/i386
	mkdir -p /var/lib/tftpboot/Debian/jessie/amd64
	mkdir -p /opt/nfs/Debian/jessie/i386
	mkdir -p /opt/nfs/Debian/jessie/amd64

	mkdir -p /var/lib/tftpboot/fedora/23/i386
	mkdir -p /var/lib/tftpboot/fedora/23/amd64
	mkdir -p /opt/nfs/fedora/23/i386
	mkdir -p /opt/nfs/fedora/23/amd64

	mkdir -p /var/lib/tftpboot/openSUSE/42.1/i386
	mkdir -p /var/lib/tftpboot/openSUSE/42.1/amd64
	mkdir -p /opt/nfs/openSUSE/42.1/i386
	mkdir -p /opt/nfs/openSUSE/42.1/amd64

	mkdir -p /var/lib/tftpboot/CentOS/7/i386
	mkdir -p /var/lib/tftpboot/CentOS/7/amd64
	mkdir -p /opt/nfs/CentOS/7/i386
	mkdir -p /opt/nfs/CentOS/7/amd64
}

function primeros () {
	apt-get -q update
	apt-get -y install dnsmasq nfs-kernel-server tftpd-hpa syslinux
	echo "dhcp-range=192.168.1.200,192.168.1.250,12h" >> /etc/dnsmasq.conf
	echo "dhcp-no-override" >> /etc/dnsmasq.conf
	echo "enable-tftp" >> /etc/dnsmasq.conf
	echo "tftp-root=/var/lib/tftpboot" >> /etc/dnsmasq.conf
	echo "/opt/nfs	*(rw,no_root_squash,async,no_subtree_check)" >> /etc/exports
	exportfs -a
	cp /usr/lib/syslinux/pxelinux.0 /var/lib/tftpboot
	cp /usr/lib/syslinux/vesamenu.c32 /var/lib/tftpboot/
	cp /location/of/image/logo.png /var/lib/tftpboot/pxelinux.cfg/ 
}

function limpieza () {
	history -c
	apt-get clean
	rm -rf /root/.local/share/Trash/*
	rm -rf /home/*/.local/share/Trash/*
	rm -rf /home/*/.cache/*
	rm -rf /tmp/*
	rm -rf /var/tmp/*
	echo -e "\e[00;1;92mFinalizado...\e[00m"
	touch /root/.listo
}

function menu () {

echo "DEFAULT vesamenu.c32" > /var/lib/tftpboot/pxelinux.cfg/default
echo "TIMEOUT 600" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "ONTIMEOUT BootLocal" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "PROMPT 0" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU INCLUDE pxelinux.cfg/pxe.conf" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "NOESCAPE 1" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "LABEL BootLocal" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        localboot 0" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        TEXT HELP" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        Boot to local hard disk" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        ENDTEXT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU BEGIN Ubuntu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU TITLE Ubuntu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        LABEL Previous" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU LABEL Previous Menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        TEXT HELP" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        Return to previous menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        ENDTEXT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU EXIT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU SEPARATOR" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU INCLUDE Ubuntu/Ubuntu.menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU END" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU BEGIN CentOS" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU TITLE CentOS" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        LABEL Previous" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "	      MENU LABEL Previous Menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        TEXT HELP" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        Return to previous menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        ENDTEXT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU EXIT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU SEPARATOR" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU INCLUDE CentOS/CentOS.menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU END" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU BEGIN Fedora" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU TITLE Fedora" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        LABEL Previous" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU LABEL Previous Menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        TEXT HELP" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        Return to previous menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        ENDTEXT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU EXIT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU SEPARATOR" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU INCLUDE Fedora/Fedora.menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU END" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU BEGIN openSUSE" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU TITLE openSUSE" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        LABEL Previous" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU LABEL Previous Menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        TEXT HELP" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        Return to previous menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        ENDTEXT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU EXIT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU SEPARATOR" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU INCLUDE openSUSE/openSUSE.menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU END" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU BEGIN Debian" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU TITLE Debian" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        LABEL Previous" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU LABEL Previous Menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        TEXT HELP" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        Return to previous menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        ENDTEXT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU EXIT" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU SEPARATOR" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "        MENU INCLUDE debian/debian.menu" >> /var/lib/tftpboot/pxelinux.cfg/default
echo "MENU END" >> /var/lib/tftpboot/pxelinux.cfg/default


}

#000000000000000000000000

#ubuntu
echo "dhcp-boot=pxelinux.0,root,192.168.1.1" >> /etc/dnsmasq.conf
systemctl restart dnsmasq.service
wget -O - http://archive.ubuntu.com/ubuntu/dists/trusty-updates/main/installer-i386/current/images/netboot/netboot.tar.gz > /var/lib/tftpboot/netboot.tar.gz
cd /var/lib/tftpboot/
tar -xzf netboot.tar.gz
rm -f /var/lib/tftpboot/netboot.tar.gz

#debian
echo "dhcp-boot=pxelinux.0" >> /etc/dnsmasq.conf
systemctl restart dnsmasq.service
wget -O - http://httpredir.debian.org/debian/dists/jessie/main/installer-i386/current/images/netboot/netboot.tar.gz > /var/lib/tftpboot/netboot.tar.gz
cd /var/lib/tftpboot/
tar -xzf netboot.tar.gz
rm -f /var/lib/tftpboot/netboot.tar.gz

#000000000000000000000000

rm -f /run/$(basename $0).pid
exit 0
